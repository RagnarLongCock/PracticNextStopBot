<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <title>–£–Ω–≥–∞ –±—É–Ω–≥–∞</title>
  <link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>
  <div class="container">
    <div id="pasha">
      <button id="toggleSpeech" aria-label="–û–∑–≤—É—á–∫–∞">üîä –í–∫–ª—é—á–∏—Ç—å –æ–∑–≤—É—á–∫—É</button>
      <div id="pasha_niz">
        <img src="image/Pasha.svg" alt="–ü–∞—à–∞" />
        <button id="theme-toggle">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É</button>
      </div>
    </div>

    <div id="messages">
      <div id="chat"></div>
      <div id="form_inp">
        <form id="inputForm">
          <input type="text" id="inputMsg" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" required />
          <button type="submit" id="sendBtn"></button>
        </form>
      </div>
    </div>
  </div>

  <script>
    const chat = document.getElementById("chat");
    const form = document.getElementById("inputForm");
    const input = document.getElementById("inputMsg");
    let speechEnabled = false;

    // –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –æ—Ç —ç–º–æ–¥–∑–∏ (–¥–ª—è –æ–∑–≤—É—á–∫–∏)
    function cleanText(text) {
      return text.replace(/([\u{1F600}-\u{1F64F}]|[\u{2700}-\u{27BF}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{2600}-\u{26FF}])/gu, '').trim();
    }

    // –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
    function addMessage(text, sender) {
      const div = document.createElement("div");
      div.className = "message " + sender;

      if (sender === "bot") {
        const content = document.createElement("div");
        content.innerHTML = text;

        const speakBtn = document.createElement("button");
        speakBtn.textContent = "üîä –û–∑–≤—É—á–∏—Ç—å";
        speakBtn.className = "speak-btn";

        const plainText = cleanText(content.textContent || content.innerText || "");

        speakBtn.onclick = () => {
          if (speechEnabled) speak(plainText);
        };

        div.appendChild(content);
        div.appendChild(speakBtn);

        if (speechEnabled && plainText.length > 0) {
          speak(plainText);
        }

      } else {
        div.textContent = text;
      }

      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    // –û–∑–≤—É—á–∫–∞
    function speak(text) {
      if ('speechSynthesis' in window && text) {
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'ru-RU';
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(msg);
      }
    }

    //–û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è (—á–µ—Ä–µ–∑ Yandex Speller API)
    async function correctText(text) {
      try {
        const response = await fetch(`https://speller.yandex.net/services/spellservice.json/checkText?text=${encodeURIComponent(text)}`);
        const result = await response.json();

        let corrected = text;
        result.forEach(error => {
          if (error.s.length > 0) {
            corrected = corrected.replace(error.word, error.s[0]);
          }
        });

        return corrected;
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –æ—Ä—Ñ–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏–∏:", err);
        return text;
      }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ Rasa
    async function sendMessage(message) {
      addMessage(message, "user");
      input.value = "";
      try {
        const response = await fetch("http://localhost:5005/webhooks/rest/webhook", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sender: "user1", message: message })
        });
        const data = await response.json();
        if (data.length === 0) {
          addMessage("–ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª :(", "bot");
        } else {
          data.forEach(resp => {
            addMessage(resp.text || "", "bot");
          });
        }
      } catch (error) {
        addMessage("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É.", "bot");
        console.error(error);
      }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã ‚Äî —Å –æ—Ä—Ñ–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏–µ–π
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const original = input.value.trim();
      if (original) {
        const corrected = await correctText(original);
        sendMessage(corrected);
      }
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –æ–∑–≤—É—á–∫–∏
    document.getElementById("toggleSpeech").addEventListener("click", () => {
      speechEnabled = !speechEnabled;
      document.getElementById("toggleSpeech").textContent =
        speechEnabled ? "üîá –û—Ç–∫–ª—é—á–∏—Ç—å –æ–∑–≤—É—á–∫—É" : "üîä –í–∫–ª—é—á–∏—Ç—å –æ–∑–≤—É—á–∫—É";
      if (!speechEnabled) {
        window.speechSynthesis.cancel();
      }
    });

    // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç –±–æ—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.onload = () => {
      const welcomeText =
        "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –∏ –ø–æ–º–æ–≥—É –≤–∞–º —Å –≤—ã–±–æ—Ä–æ–º –ª–µ—Ç–Ω–µ–π —Å–º–µ–Ω—ã –¥–ª—è —Ä–µ–±—ë–Ω–∫–∞.\n\n" +
        "–°–µ–π—á–∞—Å –¥–æ—Å—Ç—É–ø–Ω—ã –¥–≤–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è:\n\n" +
        "–ú–∏—Ä –Ω–∞—É–∫ –∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏ ‚Äî –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è —Å 23 –∏—é–Ω—è –ø–æ 6 –∏—é–ª—è 2025 –≥–æ–¥–∞.\n" +
        "–°–æ–∑–¥–∞–Ω–∏–µ 3D-–º–∏—Ä–æ–≤ –≤ –†–æ–±–ª–æ–∫—Å ‚Äî –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è —Å 7 –ø–æ 20 –∏—é–ª—è 2025 –≥–æ–¥–∞.\n\n" +
        "–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å ‚Äî –∏ —è —Ä–∞—Å—Å–∫–∞–∂—É –ø—Ä–æ –ø–∏—Ç–∞–Ω–∏–µ, –ø—Ä–æ–≥—Ä–∞–º–º—É, —Ü–µ–Ω—É –∏ –¥—Ä—É–≥–∏–µ –¥–µ—Ç–∞–ª–∏!";

      const welcomeHTML =
        "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –∏ –ø–æ–º–æ–≥—É –≤–∞–º —Å –≤—ã–±–æ—Ä–æ–º –ª–µ—Ç–Ω–µ–π —Å–º–µ–Ω—ã –¥–ª—è —Ä–µ–±—ë–Ω–∫–∞.<br><br>" +
        "üåø <b>–ú–∏—Ä –Ω–∞—É–∫ –∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏</b> ‚Äî –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è —Å <b>23 –∏—é–Ω—è –ø–æ 6 –∏—é–ª—è 2025 –≥–æ–¥–∞</b><br>" +
        "üïπÔ∏è <b>–°–æ–∑–¥–∞–Ω–∏–µ 3D-–º–∏—Ä–æ–≤ –≤ Roblox</b> ‚Äî –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è —Å <b>7 –ø–æ 20 –∏—é–ª—è 2025 –≥–æ–¥–∞</b><br><br>" +
        "–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å ‚Äî –∏ —è —Ä–∞—Å—Å–∫–∞–∂—É –ø—Ä–æ –ø–∏—Ç–∞–Ω–∏–µ, –ø—Ä–æ–≥—Ä–∞–º–º—É, —Ü–µ–Ω—É –∏ –¥—Ä—É–≥–∏–µ –¥–µ—Ç–∞–ª–∏!";

      addMessage(welcomeHTML, "bot");
    };

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–≤–µ—Ç–ª–æ–π –∏ —Ç—ë–º–Ω–æ–π —Ç–µ–º—ã
    const toggleButton = document.getElementById('theme-toggle');
    const body = document.body;

    toggleButton.addEventListener('click', () => {
      body.classList.toggle('dark-theme');
      // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–º—É –≤ localStorage
      if (body.classList.contains('dark-theme')) {
        localStorage.setItem('theme', 'dark');
      } else {
        localStorage.setItem('theme', 'light');
      }
    });

    // –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äî —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Ç–µ–º—É
    window.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('theme');

      if (savedTheme) {
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –≤—ã–±–∏—Ä–∞–ª —Ç–µ–º—É ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë
        if (savedTheme === 'dark') {
          body.classList.add('dark-theme');
        }
      } else {
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤—ã–±–∏—Ä–∞–ª ‚Äî —Å–º–æ—Ç—Ä–∏–º –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—É—é —Ç–µ–º—É
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (prefersDark) {
          body.classList.add('dark-theme');
        }
      }
    });

    // –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äî —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Ç–µ–º—É
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      if (!localStorage.getItem('theme')) {
        if (e.matches) {
          body.classList.add('dark-theme');
        } else {
          body.classList.remove('dark-theme');
        }
      }
    });

  </script>
</body>

</html>