<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ê–¥–º–∏–Ω–∫–∞ –±–æ—Ç–∞</title>
  <link rel="stylesheet" href="/static/admin.css" />
</head>
<body>
  <div class="admin-container">
    <h1>üß† –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —á–∞—Ç-–±–æ—Ç–∞</h1>

    <section>
      <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∏–Ω—Ç–µ–Ω—Ç</h2>
      <input type="text" id="new-intent-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Ç–∞">
      <button onclick="createIntent()">–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–Ω—Ç</button>
      <button onclick="window.location.href='GPT';">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ–Ω—Ç</button>
    </section>

    <section>
      <h2>üìö –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–Ω—Ç–µ–Ω—Ç—ã</h2>
      <select id="intent-list" onchange="loadExamples()"></select>
      <ul id="examples-list"></ul>
      <input type="text" id="new-example" placeholder="–ù–æ–≤–∞—è —Ñ—Ä–∞–∑–∞">
      <button onclick="addExample()">–î–æ–±–∞–≤–∏—Ç—å —Ñ—Ä–∞–∑—É</button>
    </section>

    <section>
      <h2>üí¨ –û—Ç–≤–µ—Ç—ã –∫–∞—Å—Ç–æ–º–Ω—ã—Ö action'–æ–≤</h2>
      <select id="response-list" onchange="loadResponseText()"></select>
      <textarea id="response-text" rows="4" placeholder="–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞..."></textarea>
      <button onclick="saveResponse()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
    </section>

    <section>
      <h2>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª—å—é –∏ –±–æ—Ç–æ–º</h2>
      <button onclick="trainModel()">üîÅ –ü–µ—Ä–µ–æ–±—É—á–∏—Ç—å Rasa</button>
      <button onclick="startBot()">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞</button>
      <button onclick="stopBot()">‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞</button>
      <pre id="train-status"></pre>
    </section>
  </div>

  <script>
    let responses = {};

    async function fetchJSON(url, options = {}) {
      const res = await fetch(url, options);
      return await res.json();
    }

    async function populateIntents() {
      const intents = await fetchJSON("/api/intents");
      const select = document.getElementById("intent-list");
      select.innerHTML = "";
      intents.forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
      });
      if (intents.length) loadExamples();
    }

    async function loadExamples() {
      const intent = document.getElementById("intent-list").value;
      const examples = await fetchJSON(`/api/intents/${intent}`);
      const ul = document.getElementById("examples-list");
      ul.innerHTML = "";
      examples.forEach((ex, idx) => {
        const li = document.createElement("li");
        li.innerHTML = `${ex} <button onclick="deleteExample('${intent}', ${idx})">üóëÔ∏è</button>`;
        ul.appendChild(li);
      });
    }

    async function deleteExample(intent, index) {
      await fetch(`/api/intents/${intent}/${index}`, { method: "DELETE" });
      loadExamples();
    }

    async function addExample() {
      const intent = document.getElementById("intent-list").value;
      const text = document.getElementById("new-example").value.trim();
      if (!text) return;
      await fetch(`/api/intents/${intent}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });
      document.getElementById("new-example").value = "";
      loadExamples();
    }

    async function createIntent() {
      const name = document.getElementById("new-intent-name").value.trim();
      if (!name) return;
      const res = await fetch("/api/intents", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name })
      });
      const msg = await res.json();
      alert(msg.message);
      document.getElementById("new-intent-name").value = "";
      populateIntents();
      loadResponses();
    }

    async function loadResponses() {
      responses = await fetchJSON("/api/responses");
      const select = document.getElementById("response-list");
      select.innerHTML = "";
      Object.keys(responses).forEach(key => {
        const option = document.createElement("option");
        option.value = key;
        option.textContent = key;
        select.appendChild(option);
      });
      if (Object.keys(responses).length > 0) {
        loadResponseText();
      }
    }

    function loadResponseText() {
      const action = document.getElementById("response-list").value;
      const data = responses[action];
      const text = typeof data === "string" ? data : (data?.default || "");
      document.getElementById("response-text").value = text;
    }

    async function saveResponse() {
      const action = document.getElementById("response-list").value;
      const text = document.getElementById("response-text").value;
      await fetch(`/api/responses/${action}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });
      alert("–û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
    }

    async function trainModel() {
      const pre = document.getElementById("train-status");
      pre.textContent = "‚è≥ –ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ...";
      const res = await fetch("/api/train", { method: "POST" });
      const msg = await res.json();
      pre.textContent = msg.message;
    }

    async function startBot() {
      const pre = document.getElementById("train-status");
      pre.textContent = "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫...";
      const res = await fetch("/api/start-bot", { method: "POST" });
      const msg = await res.json();
      pre.textContent = msg.message;
    }

    async function stopBot() {
      const pre = document.getElementById("train-status");
      pre.textContent = "‚õî –û—Å—Ç–∞–Ω–æ–≤–∫–∞...";
      const res = await fetch("/api/stop-bot", { method: "POST" });
      const msg = await res.json();
      pre.textContent = msg.message;
    }

    window.onload = () => {
      populateIntents();
      loadResponses();
    };
  </script>
</body>
</html>
