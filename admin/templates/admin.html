<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å –±–æ—Ç–∞</title>
  <link rel="stylesheet" href="/static/admin.css" />
</head>
<body>
  <div class="admin-container">
    <h1>üß† –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —á–∞—Ç-–±–æ—Ç–∞</h1>

    <section>
      <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∏–Ω—Ç–µ–Ω—Ç</h2>
      <input type="text" id="new-intent-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Ç–∞">
      <button onclick="createIntent()">–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–Ω—Ç</button>
      <button id="open-gpt-btn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ–Ω—Ç</button>
    </section>

    <section>
      <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
      <div id="gpt-modal" class="modal">
        <div class="modal-content">
          <span class="close-btn">&times;</span>
          <h2>ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–Ω—Ç–µ–Ω—Ç–æ–≤</h2>
          <label>–ò–Ω—Ç–µ–Ω—Ç:</label>
          <input type="text" id="gpt-intent" placeholder="–ù–∞–ø—Ä. order_pizza" />

          <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
          <textarea id="gpt-description" placeholder="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –∑–∞–∫–∞–∑–∞—Ç—å –ø–∏—Ü—Ü—É"></textarea>

              <div class="buttons">
                <button onclick="preview()">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
                <button onclick="generate()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button onclick="rollback()">–û—Ç–∫–∞—Ç</button>
              </div>

<ul id="gpt-output"></ul>
        </div>
      </div>
    </section>

    <section>
      <h2>üìö –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–Ω—Ç–µ–Ω—Ç—ã</h2>

      <!-- –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∏–Ω—Ç–µ–Ω—Ç–æ–≤ -->
      <select id="intent-list" onchange="loadExamples()"></select>

      <!-- –¢–∞–±–ª–∏—Ü–∞ —Å —Ñ—Ä–∞–∑–∞–º–∏ -->
      <div class="table-container">
        <table class="examples-table">
          <thead><tr><th>–§—Ä–∞–∑–∞</th><th>–£–¥–∞–ª–∏—Ç—å</th></tr></thead>
          <tbody id="examples-list"></tbody>
        </table>
      </div>

      <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Ñ—Ä–∞–∑—ã -->
      <input type="text" id="new-example" placeholder="–ù–æ–≤–∞—è —Ñ—Ä–∞–∑–∞">
      <button onclick="addExample()">–î–æ–±–∞–≤–∏—Ç—å —Ñ—Ä–∞–∑—É</button>
    </section>

    <section>
      <h2>üí¨ –û—Ç–≤–µ—Ç—ã –∫–∞—Å—Ç–æ–º–Ω—ã—Ö action'–æ–≤</h2>
      <select id="response-list" onchange="loadResponseText()"></select>
      <textarea id="response-text" rows="4" placeholder="–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞..."></textarea>
      <button onclick="saveResponse()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
    </section>

    <section>
      <h2>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª—å—é –∏ –±–æ—Ç–æ–º</h2>
      <button onclick="trainModel()">üîÅ –ü–µ—Ä–µ–æ–±—É—á–∏—Ç—å Rasa</button>
      <button onclick="startBot()">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞</button>
      <button onclick="stopBot()">‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞</button>
      <pre id="train-status"></pre>
    </section>

    <section>

      <h2>üß∞ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h2>
      <button onclick="runCleanup()">üßπ –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</button>
      <button onclick="runBackup()">üíæ –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é</button>
      <pre id="db-status"></pre>

      <h2>–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π</h2>
      <table border="1" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th>–†–æ–ª—å</th>
            <th>–°–æ–æ–±—â–µ–Ω–∏–µ</th>
            <th>–í—Ä–µ–º—è</th>
          </tr>
        </thead>
        <tbody>
        {% for role, message, sent_at in rows %}
        <tr>
          <td>{{ role }}</td>
          <td>{{ message }}</td>
          <td>{{ sent_at }}</td>
        </tr>
        {% else %}
        <tr><td colspan="3">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </section>




  </div>

  <script>
    let responses = {};

    async function fetchJSON(url, options = {}) {
      const res = await fetch(url, options);
      return await res.json();
    }

    async function populateIntents() {
      const intents = await fetchJSON("/api/intents");
      const select = document.getElementById("intent-list");
      select.innerHTML = "";
      intents.forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
      });
      if (intents.length) loadExamples();
    }

    async function loadExamples() {
      const intent = document.getElementById("intent-list").value;
      const examples = await fetchJSON(`/api/intents/${intent}`);
      const tbody = document.getElementById("examples-list");
      tbody.innerHTML = "";
      examples.forEach((ex, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${ex}</td>
          <td><button onclick="deleteExample('${intent}', ${idx})">üóëÔ∏è</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function deleteExample(intent, index) {
      await fetch(`/api/intents/${intent}/${index}`, { method: "DELETE" });
      loadExamples();
    }

    async function addExample() {
      const intent = document.getElementById("intent-list").value;
      const text = document.getElementById("new-example").value.trim();
      if (!text) return;
      await fetch(`/api/intents/${intent}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });
      document.getElementById("new-example").value = "";
      loadExamples();
    }

    async function createIntent() {
      const name = document.getElementById("new-intent-name").value.trim();
      if (!name) return;
      const res = await fetch("/api/intents", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name })
      });
      const msg = await res.json();
      alert(msg.message);
      document.getElementById("new-intent-name").value = "";
      populateIntents();
      loadResponses();
    }

    async function loadResponses() {
      responses = await fetchJSON("/api/responses");
      const select = document.getElementById("response-list");
      select.innerHTML = "";
      Object.keys(responses).forEach(key => {
        const option = document.createElement("option");
        option.value = key;
        option.textContent = key;
        select.appendChild(option);
      });
      if (Object.keys(responses).length > 0) {
        loadResponseText();
      }
    }

    function loadResponseText() {
      const action = document.getElementById("response-list").value;
      const data = responses[action];
      const text = typeof data === "string" ? data : (data?.default || "");
      document.getElementById("response-text").value = text;
    }

    async function saveResponse() {
      const action = document.getElementById("response-list").value;
      const text = document.getElementById("response-text").value;
      await fetch(`/api/responses/${action}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });
      alert("–û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
    }

    async function trainModel() {
      const pre = document.getElementById("train-status");
      pre.textContent = "‚è≥ –ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ...";
      const res = await fetch("/api/train", { method: "POST" });
      const msg = await res.json();
      pre.textContent = msg.message;
    }

    async function startBot() {
      const pre = document.getElementById("train-status");
      pre.textContent = "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫...";
      const res = await fetch("/api/start-bot", { method: "POST" });
      const msg = await res.json();
      pre.textContent = msg.message;
    }

    async function stopBot() {
      const pre = document.getElementById("train-status");
      pre.textContent = "‚õî –û—Å—Ç–∞–Ω–æ–≤–∫–∞...";
      const res = await fetch("/api/stop-bot", { method: "POST" });
      const msg = await res.json();
      pre.textContent = msg.message;
    }

    window.onload = () => {
      populateIntents();
      loadResponses();
    };

    async function runCleanup() {
      const pre = document.getElementById("db-status");
      pre.textContent = "üßπ –û—á–∏—Å—Ç–∫–∞...";
      const res = await fetch("/api/cleanup", { method: "POST" });
      const msg = await res.json();
      pre.textContent = msg.message || msg.error;
    }

    async function runBackup() {
      const pre = document.getElementById("db-status");
      pre.textContent = "üíæ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ...";
      const res = await fetch("/api/backup", { method: "POST" });
      const msg = await res.json();
      pre.textContent = msg.message || msg.error;
    }
    //—Ñ—É–Ω–∫—Ü–∏–∏ –æ–∫–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–Ω—Ç–µ–Ω—Ç–æ–≤
    const openBtn = document.getElementById("open-gpt-btn");
    const modal = document.getElementById("gpt-modal");
    const closeBtn = modal.querySelector(".close-btn");

    openBtn.onclick = () => modal.classList.add("open-modal");
    closeBtn.onclick = () => modal.classList.remove("open-modal");
    window.onclick = e => { if (e.target === modal) modal.classList.remove("open-modal"); }

    // GPT –∏–Ω—Ç–µ–Ω—Ç—ã
    async function generate() {
      const intent = document.getElementById("gpt-intent").value.trim();
      const description = document.getElementById("gpt-description").value.trim();
      if (!intent || !description) return alert("–£–∫–∞–∂–∏—Ç–µ –∏–Ω—Ç–µ–Ω—Ç –∏ –æ–ø–∏—Å–∞–Ω–∏–µ");

      const res = await fetch("/api/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ intent, description })
      });
      const data = await res.json();
      if (data.examples) {
        displayGPTOutput(data.examples);
        alert("‚úÖ –ò–Ω—Ç–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
        populateIntents();
      } else {
        alert(data.error || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏");
      }
    }

    async function preview() {
      const description = document.getElementById("gpt-description").value.trim();
      if (!description) return alert("–£–∫–∞–∂–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ");
      const res = await fetch("/api/preview", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ description })
      });
      const data = await res.json();
      if (data.preview) {
        displayGPTOutput(data.preview);
      } else {
        alert(data.error || "–û—à–∏–±–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞");
      }
    }

    async function rollback() {
      if (!confirm("–û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω—Ç–µ–Ω—Ç–æ–≤?")) return;
      const res = await fetch("/api/rollback", { method: "POST" });
      const data = await res.json();
      if (data.status) {
        alert("‚úÖ –û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω");
        populateIntents();
      } else {
        alert(data.error || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ");
      }
    }

    function displayGPTOutput(examples) {
      const output = document.getElementById("gpt-output");
      output.innerHTML = "";
      examples.forEach(ex => {
        const li = document.createElement("li");
        li.textContent = ex;
        output.appendChild(li);
      });
    }

    const gptModal = document.getElementById("gpt-modal");
    const adminContainer = document.querySelector(".admin-container");

    document.getElementById("open-gpt-modal").onclick = () => {  gptModal.style.display = "block";
    gptModal.classList.remove("fadeout"); // –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–µ —Å–±—Ä–æ—Å–∏–ª—Å—è
    gptModal.style.animation = "fadeIn 0.3s forwards";
    adminContainer.classList.add("modal-blur");
    document.body.classList.add("modal-open");
    };

    gptModal.querySelector(".close-btn").onclick = closeModal;
    window.onclick = e => {
      if (e.target === gptModal) closeModal();
    };

    function closeModal() {
      gptModal.classList.add("fadeout");
      gptModal.style.animation = "fadeOut 0.3s forwards";

      // –û—Ç–∫–ª—é—á–∞–µ–º —Ä–∞–∑–º—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 300ms, –∫–æ–≥–¥–∞ –∞–Ω–∏–º–∞—Ü–∏—è –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è
      setTimeout(() => {
        gptModal.style.display = "none";
        gptModal.classList.remove("fadeout");
        gptModal.style.animation = "";
        adminContainer.classList.remove("modal-blur");
        document.body.classList.remove("modal-open");
      }, 300); // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ä–∞–≤–µ–Ω –≤—Ä–µ–º–µ–Ω–∏ –∞–Ω–∏–º–∞—Ü–∏–∏
    }


  </script>
</body>
</html>
