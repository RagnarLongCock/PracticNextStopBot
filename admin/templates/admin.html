<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å –±–æ—Ç–∞</title>
  <link rel="stylesheet" href="/static/admin.css" />
</head>
<body>
  <div class="admin-container">
    <h1>üß† –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —á–∞—Ç-–±–æ—Ç–∞</h1>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∏–Ω—Ç–µ–Ω—Ç–∞ -->
    <section>
      <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∏–Ω—Ç–µ–Ω—Ç</h2>
      <input type="text" id="new-intent-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Ç–∞">
      <button onclick="createIntent()">–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–Ω—Ç</button>
      <button id="open-gpt-btn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ–Ω—Ç</button>
    </section>

    <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–Ω—Ç–µ–Ω—Ç—ã –∏ –ø—Ä–∏–º–µ—Ä—ã -->
    <section>
      <h2>üìö –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–Ω—Ç–µ–Ω—Ç—ã</h2>
      <select id="intent-list" onchange="loadExamples()"></select>

      <div class="table-container">
        <table class="examples-table">
          <thead>
            <tr>
              <th>–§—Ä–∞–∑–∞</th>
              <th>–£–¥–∞–ª–∏—Ç—å</th>
            </tr>
          </thead>
          <tbody id="examples-list"></tbody>
        </table>
      </div>

      <input type="text" id="new-example" placeholder="–ù–æ–≤–∞—è —Ñ—Ä–∞–∑–∞">
      <button onclick="addExample()">–î–æ–±–∞–≤–∏—Ç—å —Ñ—Ä–∞–∑—É</button>
    </section>

    <!-- –û—Ç–≤–µ—Ç—ã –∫–∞—Å—Ç–æ–º–Ω—ã—Ö action'–æ–≤ -->
    <section>
      <h2>üí¨ –û—Ç–≤–µ—Ç—ã –∫–∞—Å—Ç–æ–º–Ω—ã—Ö action'–æ–≤</h2>
      <select id="response-list" onchange="loadResponseText()"></select>
      <textarea id="response-text" rows="4" placeholder="–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞..."></textarea>
      <button onclick="saveResponse()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
    </section>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª—å—é –∏ –±–æ—Ç–æ–º -->
    <section>
      <h2>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª—å—é –∏ –±–æ—Ç–æ–º</h2>
      <button onclick="trainModel()">üîÅ –ü–µ—Ä–µ–æ–±—É—á–∏—Ç—å Rasa</button>
      <button onclick="startBot()">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞</button>
      <button onclick="stopBot()">‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞</button>
      <pre id="train-status"></pre>
    </section>

    <!-- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö -->
    <section>
      <h2>üß∞ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h2>
      <button onclick="runCleanup()">üßπ –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</button>
      <button onclick="runBackup()">üíæ –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é</button>
      <button onclick="exportExcel()">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å Excel</button>
      <pre id="db-status"></pre>
    </section>

    <!-- –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <section>
      <h2>–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π</h2>
      <div class="messages-container">
        <input type="text" id="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º...">
        <table class="messages-table">
          <thead>
            <tr>
              <th>–†–æ–ª—å</th>
              <th>–°–æ–æ–±—â–µ–Ω–∏–µ</th>
              <th>–í—Ä–µ–º—è</th>
              <th>–∏–º—è –∏–Ω—Ç–µ–Ω—Ç–∞</th>
            </tr>
          </thead>
          <tbody>
            {% for role, message, sent_at, intent_name in rows %}
            <tr>
              <td>{{ role }}</td>
              <td>{{ message }}</td>
              <td>{{ sent_at }}</td>
              <td>{{ intent_name }}</td>
            </tr>
            {% else %}
            <tr><td colspan="4">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ GPT -->
  <div id="gpt-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h2>ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–Ω—Ç–µ–Ω—Ç–æ–≤</h2>

      <label>–ò–Ω—Ç–µ–Ω—Ç:</label>
      <input type="text" id="gpt-intent" placeholder="–ù–∞–ø—Ä. order_pizza" />
      <p class="hint"><b>‚ö†Ô∏è –ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Ç–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∏–∂–Ω–µ–µ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ).</b></p>

      <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
      <textarea id="gpt-description" placeholder="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –∑–∞–∫–∞–∑–∞—Ç—å –ø–∏—Ü—Ü—É"></textarea>

      <div class="buttons">
        <button onclick="preview()">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
        <button onclick="generate()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button onclick="rollback()">–û—Ç–∫–∞—Ç</button>
      </div>
      <ul id="gpt-output"></ul>
    </div>
  </div>

  <script>
    // ======== –û–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ ========
    async function fetchJSON(url, options = {}) {
      const res = await fetch(url, options);
      return await res.json();
    }

    // ---------- –ò–Ω—Ç–µ–Ω—Ç—ã ----------
    window.onload = () => {
      populateIntents();
      loadResponses();
    };

    async function populateIntents() {
      const intents = await fetchJSON("/api/intents");
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É (—Ä—É—Å—Å–∫–∏–º –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–º –±—É–∫–≤–∞–º)
      intents.sort((a, b) => a.localeCompare(b, 'ru', {ignorePunctuation: true}));

      const select = document.getElementById("intent-list");
      select.innerHTML = "";

      intents.forEach(name => {
        const option = document.createElement("option");
        option.value = option.textContent = name;
        select.append(option);
      });

      if (intents.length) loadExamples();
    }

    async function loadExamples() {
      const intent = document.getElementById("intent-list").value;
      let examples = await fetchJSON(`/api/intents/${intent}`);

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—Ä–∞–∑—ã –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É:
      examples.sort((a, b) =>
        a.localeCompare(b, 'ru', { ignorePunctuation: true })
      );

      const tbody = document.getElementById("examples-list");
      tbody.innerHTML = "";
      examples.forEach((ex, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${ex}</td>
          <td><button onclick="deleteExample('${intent}', ${idx})">üóëÔ∏è</button></td>
        `;
        tbody.append(tr);
      });
    }

    async function deleteExample(intent, idx) {
      await fetch(`/api/intents/${intent}/${idx}`, { method: "DELETE" });
      loadExamples();
    }

    async function addExample() {
      const intent = document.getElementById("intent-list").value;
      const t = document.getElementById("new-example").value.trim();
      if (!t) return;
      await fetch(`/api/intents/${intent}`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ text: t })
      });
      document.getElementById("new-example").value = "";
      loadExamples();
    }

    async function createIntent() {
      const name = document.getElementById("new-intent-name").value.trim();
      if (!name) return;
      const res = await fetch("/api/intents", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ name })
      });
      alert((await res.json()).message);
      document.getElementById("new-intent-name").value = "";
      populateIntents();
      loadResponses();
    }

    // ---------- Responses ----------
    let responses = {};
    async function loadResponses() {
      responses = await fetchJSON("/api/responses");
      const s = document.getElementById("response-list");
      s.innerHTML = "";
      Object.keys(responses).forEach(a => {
        const o = document.createElement("option");
        o.value = o.textContent = a;
        s.append(o);
      });
      if (Object.keys(responses).length) loadResponseText();
    }
    function loadResponseText() {
      const a = document.getElementById("response-list").value;
      const v = responses[a];
      document.getElementById("response-text").value =
        typeof v==="string" ? v : (v.default||"");
    }
    async function saveResponse() {
      const a = document.getElementById("response-list").value;
      const t = document.getElementById("response-text").value;
      await fetch(`/api/responses/${a}`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ text: t })
      });
      alert("–û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
    }

    // ---------- Train & Bot ----------
    async function trainModel() {
      const pre = document.getElementById("train-status");
      pre.textContent = "‚è≥ –ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ...";
      const msg = (await fetch("/api/train",{method:"POST"})).json();
      pre.textContent = (await msg).message;
    }
    async function startBot() {
      const p = document.getElementById("train-status");
      p.textContent="‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫...";
      const msg=(await fetch("/api/start-bot",{method:"POST"})).json();
      p.textContent=(await msg).message;
    }
    async function stopBot() {
      const p = document.getElementById("train-status");
      p.textContent="‚õî –û—Å—Ç–∞–Ω–æ–≤–∫–∞...";
      const msg=(await fetch("/api/stop-bot",{method:"POST"})).json();
      p.textContent=(await msg).message;
    }

    // ---------- DB Support ----------
    async function runCleanup() {
      const p = document.getElementById("db-status");
      p.textContent="üßπ –û—á–∏—Å—Ç–∫–∞...";
      const msg = await (await fetch("/api/cleanup",{method:"POST"})).json();
      p.textContent = msg.message || msg.error;
    }
    async function runBackup() {
      const p = document.getElementById("db-status");
      p.textContent="üíæ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ...";
      const msg = await (await fetch("/api/backup",{method:"POST"})).json();
      p.textContent = msg.message || msg.error;
    }

    async function exportExcel() {
      try {
        const res = await fetch("/api/download_excel");
        if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏");

        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "dialogs.xlsx";
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
      } catch (e) {
        alert("–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è Excel: " + e.message);
      }
    }

    // ======== –ü–æ–∏—Å–∫ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º ========
    document.getElementById('search-input').addEventListener('input', function () {
      const filter = this.value.toLowerCase();
      const rows = document.querySelectorAll(".messages-table tbody tr");

      rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(filter) ? "" : "none";
      });
    });

    // ======== –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º ========
    document.querySelectorAll(".messages-table th").forEach((th, index) => {
      th.style.cursor = "pointer";
      th.addEventListener("click", () => {
        const table = th.closest("table");
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));

        const ascending = th.classList.contains("sort-asc");
        rows.sort((a, b) => {
          const aText = a.cells[index].innerText.trim();
          const bText = b.cells[index].innerText.trim();
          return ascending
            ? bText.localeCompare(aText, "ru", {numeric: true})
            : aText.localeCompare(bText, "ru", {numeric: true});
        });

        th.classList.toggle("sort-asc", !ascending);
        th.classList.toggle("sort-desc", ascending);

        tbody.innerHTML = "";
        rows.forEach(row => tbody.appendChild(row));
      });
    });


    // ======== GPT modal logic ========
    const openBtn     = document.getElementById("open-gpt-btn");
    const modal       = document.getElementById("gpt-modal");
    const modalContent= modal.querySelector(".modal-content");
    const closeBtn    = modal.querySelector(".close-btn");

    openBtn.addEventListener("click", () => {
      modal.style.display = "block";
      modal.classList.remove("closing");
      modalContent.classList.remove("closing");
      modal.classList.add("opening");
      modalContent.classList.add("opening");
      document.body.classList.add("modal-open");
      document.querySelector(".admin-container").classList.add("modal-blur");
    });

    closeBtn.addEventListener("click", closeModal);
    window.addEventListener("click", e => {
      if (e.target === modal) closeModal();
    });

    function closeModal() {
      modal.classList.remove("opening");
      modalContent.classList.remove("opening");
      modal.classList.add("closing");
      modalContent.classList.add("closing");
      modalContent.addEventListener("animationend", onAnimEnd);
    }
    function onAnimEnd(e) {
      if (e.animationName!=="scaleOut") return;
      modalContent.removeEventListener("animationend", onAnimEnd);
      modal.style.display = "none";
      modal.classList.remove("closing");
      modalContent.classList.remove("closing");
      document.body.classList.remove("modal-open");
      document.querySelector(".admin-container").classList.remove("modal-blur");
    }

    // ======== GPT API calls ========
    async function generate() {
      const intent      = document.getElementById("gpt-intent").value.trim();
      const description = document.getElementById("gpt-description").value.trim();
      if (!intent||!description) return alert("–£–∫–∞–∂–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è");
      const res = await fetch("/api/generate", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({intent,description})
      });
      const data = await res.json();
      if (data.examples) {
        displayGPTOutput(data.examples);
        alert("‚úÖ –ò–Ω—Ç–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
        populateIntents();
      } else alert(data.error||"–û—à–∏–±–∫–∞");
    }
    async function preview() {
      const description = document.getElementById("gpt-description").value.trim();
      if (!description) return alert("–£–∫–∞–∂–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ");
      const res = await fetch("/api/preview", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({description})
      });
      const data = await res.json();
      if (data.preview) displayGPTOutput(data.preview);
      else alert(data.error||"–û—à–∏–±–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞");
    }
    async function rollback() {
      if (!confirm("–û—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è?")) return;
      const res  = await fetch("/api/rollback",{method:"POST"});
      const data = await res.json();
      if (data.status) {
        alert("‚úÖ –û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω");
        populateIntents();
      } else alert(data.error||"–û—à–∏–±–∫–∞");
    }
    function displayGPTOutput(examples) {
      const out = document.getElementById("gpt-output");
      out.innerHTML = "";
      examples.forEach(e => {
        const li=document.createElement("li");
        li.textContent=e;
        out.append(li);
      });
    }
  </script>
</body>
</html>
